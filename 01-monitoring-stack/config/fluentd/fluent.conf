<source>
  @type tail
  @id in_tail_container_logs
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag kubernetes.*
  read_from_head true
  <parse>
    @type cri
  </parse>
</source>

<source>
  @type tail
  @id in_tail_system_logs
  path /var/log/syslog
  pos_file /var/log/fluentd-syslog.log.pos
  tag system.*
  read_from_head true
  <parse>
    @type syslog
  </parse>
</source>

<source>
  @type tail
  @id in_tail_auth_logs
  path /var/log/auth.log
  pos_file /var/log/fluentd-auth.log.pos
  tag auth.*
  read_from_head true
  <parse>
    @type syslog
  </parse>
</source>

<filter kubernetes.**>
  @type kubernetes_metadata
  @id filter_kube_metadata
  kubernetes_url "#{ENV['FLUENT_FILTER_KUBERNETES_URL'] || 'https://' + ENV['KUBERNETES_SERVICE_HOST'] + ':' + ENV['KUBERNETES_SERVICE_PORT'] + '/api'}"
  verify_ssl "#{ENV['KUBERNETES_VERIFY_SSL'] || true}"
  ca_file "#{ENV['KUBERNETES_CA_FILE']}"
</filter>

<filter kubernetes.**>
  @type record_transformer
  @id filter_kube_metadata_transformer
  <record>
    kubernetes_host "#{ENV['KUBERNETES_NODE_NAME']}"
  </record>
</filter>

<match kubernetes.**>
  @type loki
  @id out_loki
  url "http://loki:3100"
  <label>
    stream
  </label>
  <label>
    level
  </label>
  <label>
    kubernetes_namespace
  </label>
  <label>
    kubernetes_pod_name
  </label>
  <label>
    kubernetes_container_name
  </label>
  <label>
    kubernetes_host
  </label>
  <buffer>
    @type file
    path /var/log/fluentd-buffers/kubernetes.*.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

<match system.**>
  @type loki
  @id out_loki_system
  url "http://loki:3100"
  <label>
    stream
  </label>
  <label>
    level
  </label>
  <label>
    hostname
  </label>
  <buffer>
    @type file
    path /var/log/fluentd-buffers/system.*.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>

<match auth.**>
  @type loki
  @id out_loki_auth
  url "http://loki:3100"
  <label>
    stream
  </label>
  <label>
    level
  </label>
  <label>
    hostname
  </label>
  <buffer>
    @type file
    path /var/log/fluentd-buffers/auth.*.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_thread_count 2
    flush_interval 5s
    retry_forever
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>
